## 前言

<p>  因为老师的需要，需要实现这样一个及时通讯软件，用户可以在模糊查询其他人的位置是否在一个范围内，而不让服务器和查询用户知道被查询用户的具体位置，这是一个位置隐私保护问题，老师提供了一个差分算法，而我们负责实现这个场景，即设计一个IM。</p>

## 需求

<p>  由于演示效果的必要，无需设计太多的IM的功能，只需要进行设计注册，登录，添加好友，查询好友位置的功能就可以了。</p>
<p>  我想的是使用C/S架构，用Android来写客户端，用Java来做服务器端，通信采用的TCP长连接的方式，算法实现部分使用BigInteger类，这样可以说是最简单的实现方式了，因为时间紧迫，只能如此。</p>

## 客户端
<p>  对于客户端，我们首先要实现的是登录界面，提供登录和注册的功能，再提供一个注册页面实现具体注册，最后实现一个查询页面实现我们需要的查询好友位置，添加删除好友等等。</p>
<p>  注册登录的逻辑如大多数书籍上所说，客户端也仅仅需要实现提交用户输入的数据即可，但是因为是参加安全的比赛，所有需要传输的数据都需要使用加密算法，而且必须使用国密标准。第一次的注册即第一次可信信道建立是使用公钥加密算法实现，APP内置一个大素数作为公钥，其和服务器内的大素数私钥为一个公私钥对，使用sm4标准。登录过程中密码使用sm3国密哈希算法实现对密码哈希后提交给服务器进行验证，同时也提交一个自己生成的公钥，若登录成功，则服务器使用这个公钥来建立借来来通信使用的可信信道</p>
<p>  登录成功后，便进入MainActivity,于此同时需要单独新建立一个新的后台线程来与服务进行通信，因为没有使用框架，只能自己用TCP长连接实现与服务器的通信，TCP长连接的维持是靠定期发送心跳包来实现，后台线程与MainActivity间的通信采用的是广播机制，即BroadcastReceiver类。</p>
<p>  MainActivity中实现的功能有显示好友列表，添加好友，查询好友位置，我将界面设置在一个地图页面上，使用的是高德地图的API。用户的好友列表在登录过程中更新，添加好友也会更新。因为查询好友位置和添加好友需要与服务器进行交互，所以我在这两个功能的实现中新建了一个线程，此线程产生的MainActivity的UI更新是使用Handler类来实现的。</p>
<p>  查询好友的功能按照需求是这样的，在地图上选择一个范围一个圆或者一个凸多边形，然后服务器返回加密查询结果，即有多少在线好友在此范围内。我的想法是这样的用户向服务器发送一个查询请求，服务器先返回所有在线的好友数量，接着等待服务器返回的查询结果，若超过预定时间未收到所有结果则直接返回已收到的查询结果，即我设置了定时器来实现。</p>
<p>  至于查询范围的实现，圆形范围很简单，选择一个点作为圆心，再使用一个SeekBar即可可视化的选择范围，至于凸多边形的选择则需要一个算法进行判定了，当最后一个点添加后不为凸多边形即可视为图形选择成功。</p>

## 服务器端

<p>  服务器与客户端的连接通过服务器为每一个用户建立的线程与客户端的的后台线程之间的TCP连接进行通信，因为服务器和和客户端都是使用Java，所以我就使用了Java中的ObjectInputStream类和ObjectOutputStream类，只需保证传送的object是可序列化的即可，通过定义类中不同的属性就可以实现通信所需的协议。</p>

服务器的具体实现有：
	1. 采用TCP链接，服务器端监听，每有一个客户端请求建立链接，新建一个线程处理程序，设定一个超时时间，若服务器或客户端任意一方长时间未响应，自动断开连接，即实现一个心跳处理;
	2. 使用HashMap维护已连接的用户标示符以及其对应的socket;
	3. 建立一个简单的协议，区分注册信息，登录信息，协商公钥信息，协商回话秘钥信息，请求查询信息，返回查询信息;
	4. 使用MySQL保存用户的好友信息，公钥.
<p>  至此一个简单的IM软件就完成了。</p>

<p>  面临的问题，就是完全不能承受大规模用户的使用的能力，收到学长的启发，服务器端可以放弃Java端，使用c++编写服务器，这样可以利用io复用，线程池，应用缓冲区等技术实现高并发的能力，Android端使用分装好的Mina框架实现通信，正在实现处理中。</p>